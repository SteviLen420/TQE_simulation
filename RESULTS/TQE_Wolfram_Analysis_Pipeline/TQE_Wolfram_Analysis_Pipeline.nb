(* SPDX-License-Identifier: MIT *)
(* Copyright (c) 2025 Stefan Len *)

(* ================================================================== *)
(*  Simple mathematical check for all CSV files in a simulation run   *)
(*  Author: Stefan Len                                                *)
(* ================================================================== *)

ClearAll["Global`*"];

(* Safe import of CSV as Dataset, empty if error *)
safeImport[f_] := Quiet @ Check[Import[f, "Dataset"], Dataset[{}]];

(* Analyze one CSV file *)
analyzeCSV[file_String] := Module[{ds},
  
  (* Import CSV safely *)
  ds = safeImport[file];
  
  (* If file is empty, return simple status *)
  If[Length[ds] == 0, 
    Return[<|"File" -> FileBaseName[file], "Status" -> "Empty"|>]
  ];
  
  (* Basic mathematical sanity checks *)
  <|
    "File" -> FileBaseName[file],
    "TotalRows" -> Length[ds],
    "AnyNaN" -> AnyTrue[Flatten[Normal[ds]], NumericQ[#] && Not[NumberQ[#]] &],
    "AnyInfinity" -> AnyTrue[Flatten[Normal[ds]], # === Infinity || # === -Infinity &],
    "Mean" -> Quiet@Mean[Flatten[Normal[ds]]],
    "StdDev" -> Quiet@StandardDeviation[Flatten[Normal[ds]]]
  |>
];

(* ================================================================== *)
(*  Main execution: scan all CSVs in the chosen simulation directory  *)
(* ================================================================== *)

(* Path to your simulation folder with CSV files *)
simDir = "/Users/stevilen/Desktop/TQE_EI_SIMULATION_COLAB_GPU/TQE_Universe_Simulation_full_Pipeline_EI_20250918_081329/CSV";

files = FileNames["*.csv", simDir];
Print["ðŸ“‚ Found CSV files: ", Length[files]];

results = checkCSV /@ files;

(* Show results as a nice table *)
Dataset[results]

(* ================================================================== *)
(*  Export results to Desktop (both CSV + JSON)                       *)
(* ================================================================== *)

timestamp = DateString[{"Year","Month","Day","Hour","Minute","Second"}];
outDir = FileNameJoin[{$HomeDirectory, "Desktop", "TQE_Math_Check_" <> timestamp}];
If[!DirectoryQ[outDir], CreateDirectory[outDir, CreateIntermediateDirectories -> True]];

Export[FileNameJoin[{outDir, "math_check_results.csv"}], results];
Export[FileNameJoin[{outDir, "math_check_results.json"}],
  results /. Missing[_] -> Null
];

Print["âœ… Math check finished, results saved to: ", outDir];
