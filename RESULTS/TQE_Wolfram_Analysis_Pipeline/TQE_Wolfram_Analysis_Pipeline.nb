(* SPDX-License-Identifier: MIT *)
(* Copyright (c) 2025 Stefan Len *)

(* ================================================================== *)
(*  Simple mathematical check for all CSV files in a simulation run   *)
(*  Author: Stefan Len                                                *)
(* ================================================================== *)

ClearAll["Global`*"];

(* Safe import of CSV as Dataset, empty if error *)
safeImport[f_] := Quiet @ Check[Import[f, "Dataset"], Dataset[{}]];

(* Function to check one CSV file *)
checkCSV[file_] := Module[{ds, nums},
  
  ds = safeImport[file];
  If[Length[ds] == 0,
    Return[<|"File" -> FileBaseName[file], "Status" -> "Empty">]
  ];
  
  (* Collect all numeric values in the dataset *)
  nums = Cases[Flatten@Normal[ds], _?NumericQ, âˆž];
  
  <|
    "File"         -> FileBaseName[file],
    "Rows"         -> Length[ds],
    "Numeric Count"-> Length[nums],
    "Missing?"     -> Count[nums, _Missing],
    "NaN?"         -> Count[nums, _?(Not@*NumericQ)],
    "Infinity?"    -> Count[nums, x_ /; Abs[x] === âˆž],
    "Mean"         -> If[nums === {}, "NA", Mean[nums]],
    "StdDev"       -> If[nums === {}, "NA", StandardDeviation[nums]]
  |>
];

(* ================================================================== *)
(*  Main execution: scan all CSVs in the chosen simulation directory  *)
(* ================================================================== *)

(* Path to your simulation folder with CSV files *)
simDir = "/Users/stevilen/Desktop/TQE_EI_SIMULATION_COLAB_GPU/TQE_Universe_Simulation_full_Pipeline_EI_20250918_081329/CSV";

files = FileNames["*.csv", simDir];
Print["ðŸ“‚ Found CSV files: ", Length[files]];

results = checkCSV /@ files;

(* Show results as a nice table *)
Dataset[results]

(* ================================================================== *)
(*  Export results to Desktop (both CSV + JSON)                       *)
(* ================================================================== *)

timestamp = DateString[{"Year","Month","Day","Hour","Minute","Second"}];
outDir = FileNameJoin[{$HomeDirectory, "Desktop", "TQE_Math_Check_" <> timestamp}];
If[!DirectoryQ[outDir], CreateDirectory[outDir, CreateIntermediateDirectories -> True]];

Export[FileNameJoin[{outDir, "math_check_results.csv"}], results];
Export[FileNameJoin[{outDir, "math_check_results.json"}],
  results /. Missing[_] -> Null
];

Print["âœ… Math check finished, results saved to: ", outDir];
