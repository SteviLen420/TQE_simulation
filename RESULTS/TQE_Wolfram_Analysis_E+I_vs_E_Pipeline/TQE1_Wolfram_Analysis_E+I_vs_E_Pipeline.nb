(* SPDX-License-Identifier: MIT *)
(* Author: Stefan Len, 2025 *)

(* ============================= *)
(* 1) HELPER FUNCTIONS           *)
(* ============================= *)

(* Convert input to a Dataset safely *)
toDS[x_] := Quiet@Check[
   Which[
    Head[x] === Dataset, x,
    ListQ[x] && Length[x] > 0, Dataset[x],
    StringQ[x], Import[x, "Dataset"],
    True, Dataset[{}]
    ],
   Dataset[{}]
   ];

(* Replace Missing with Null for JSON export *)
cleanForJSON[x_] := x /. Missing[_] -> Null;

(* ============================= *)
(* 2) LOAD FILES INTO DATASETS   *)
(* ============================= *)

filesA = FileNames["*.csv", "CSV_E+I_*", Infinity];
filesB = FileNames["*.csv", "CSV_energy_only_*", Infinity];

(* Import all CSVs into datasets, ignoring missing *)
dsA = DeleteMissing[toDS /@ filesA];
dsB = DeleteMissing[toDS /@ filesB];

(* Merge all datasets into one big dataset per group *)
bigA = If[dsA === {}, Dataset[{}], Dataset@Flatten[Normal /@ dsA, 1]];
bigB = If[dsB === {}, Dataset[{}], Dataset@Flatten[Normal /@ dsB, 1]];

(* ============================= *)
(* 3) COMPARE MEAN VALUES        *)
(* ============================= *)

(* Find common columns between both groups *)
commonCols = 
  Intersection[Keys@First@Normal@bigA, Keys@First@Normal@bigB];

(* Build comparison association for each column *)
comp = Association@Table[
    col -> <|
      "mean_E+I" -> Mean@DeleteMissing[Normal@bigA[All, col]],
      "mean_E-only" -> Mean@DeleteMissing[Normal@bigB[All, col]],
      "diff" -> (Mean@DeleteMissing[Normal@bigA[All, col]] - 
         Mean@DeleteMissing[Normal@bigB[All, col]])
      |>,
    {col, commonCols}
    ];

(* ============================= *)
(* 4) EXPORT TO DESKTOP          *)
(* ============================= *)

(* Create output folder on Desktop *)
outDir = FileNameJoin[{$HomeDirectory, "Desktop", "TQE_Comparison"}];
If[! DirectoryQ[outDir], 
   CreateDirectory[outDir, CreateIntermediateDirectories -> True]];

(* Export CSV: one row per column with mean values and difference *)
Export[FileNameJoin[{outDir, "comparison_table.csv"}],
  Prepend[
   KeyValueMap[{#1, #2["mean_E+I"], #2["mean_E-only"], #2["diff"]} &, comp],
   {"Column", "Mean_E+I", "Mean_E-only", "Difference"}
   ]
  ];

(* Export JSON: association of all results *)
Export[FileNameJoin[{outDir, "comparison_table.json"}],
  cleanForJSON@comp
  ];

Print["Results exported to: ", outDir];
