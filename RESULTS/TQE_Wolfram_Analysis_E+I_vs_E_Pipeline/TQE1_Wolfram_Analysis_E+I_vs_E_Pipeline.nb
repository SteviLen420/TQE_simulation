(* SPDX-License-Identifier: MIT *)
(* Author: Stefan Len, 2025 *)

(* ============================= *)
(* 1) HELPER FUNCTIONS           *)
(* ============================= *)

(* Convert safely into Dataset *)
toDS[x_] := Quiet@Check[
   Which[
    Head[x] === Dataset, x,
    ListQ[x] && Length[x] > 0, Dataset[x],
    StringQ[x], Import[x, "Dataset"],
    True, Dataset[{}]
    ],
   Dataset[{}]
   ];

(* Replace Missing with Null for JSON export *)
cleanForJSON[x_] := x /. Missing[_] -> Null;

(* Compute summary stats for a numeric column *)
summaryStats[data_, col_] := <|
   "Mean" -> N@Mean[DeleteMissing[data[All, col]]],
   "StdDev" -> N@StandardDeviation[DeleteMissing[data[All, col]]],
   "Min" -> N@Min[DeleteMissing[data[All, col]]],
   "Max" -> N@Max[DeleteMissing[data[All, col]]],
   "Count" -> Length[DeleteMissing[data[All, col]]]
   |>;

(* ============================= *)
(* 2) LOAD ALL FILES             *)
(* ============================= *)

(* Choose directory with CSVs (change path if needed) *)
inputDir = "/ /Users/stevilen/Desktop/TQE_EI_SIMULATION_COLAB_GPU/TQE_Universe_Simulation_full_Pipeline_E+I_20250918_081329/CSV "; 

files = FileNames["*.csv", inputDir, Infinity];

(* Import each file as Dataset *)
datasets = AssociationMap[toDS, files];

(* ============================= *)
(* 3) ANALYZE EACH FILE          *)
(* ============================= *)

results = Association@Table[
    file -> Module[{ds, cols},
      ds = datasets[file];
      cols = Select[Keys@First@Normal[ds], 
        NumericQ[Quiet[ds[1, #]]] &]; (* only numeric columns *)
      Association@Table[
        col -> summaryStats[ds, col],
        {col, cols}
        ]
      ],
    {file, Keys[datasets]}
    ];

(* ============================= *)
(* 4) EXPORT RESULTS             *)
(* ============================= *)

outDir = FileNameJoin[{$HomeDirectory, "Desktop", "TQE_AllStats"}];
If[! DirectoryQ[outDir], 
   CreateDirectory[outDir, CreateIntermediateDirectories -> True]];

(* Export JSON *)
Export[FileNameJoin[{outDir, "all_stats.json"}], cleanForJSON@results];

(* Export CSV (flattened for Excel) *)
csvData = 
  Flatten[KeyValueMap[
    Function[{file, cols},
      KeyValueMap[
        Function[{col, stats}, 
          Prepend[Values[stats], {file, col}]
        ],
        cols
        ]
      ],
    results
    ], 1];

csvHeader = {"File", "Column", "Mean", "StdDev", "Min", "Max", "Count"};

Export[FileNameJoin[{outDir, "all_stats.csv"}], 
  Prepend[csvData, csvHeader]];

Print["âœ… Results exported to: ", outDir];
