(* SPDX-License-Identifier: MIT *)

(* ================================================================== *)
(*  TQE_Wolfram_E_Only_Math_Check_Summary_All_JSON.nb                 *)
(* ================================================================== *)
(*  Purpose: Summarize ALL statistics from ALL E_only JSON files.     *)
(*           Each file/column/statistic is flattened into a row.      *)
(*           Then compute global averages across all files.           *)
(* ================================================================== *)

(* ========= User input: folder that contains E_only JSONs ========= *)
rootEonly = "/Users/stevilen/Desktop/TQE_E_plus_I_vs_E_only/math_check_results_E_only_JSON";

(* ========= Find all E_only JSON files ========= *)
allFiles = Union[
   FileNames["*.json", rootEonly, Infinity],
   FileNames["*.JSON", rootEonly, Infinity]
];

keepFiles = allFiles;

If[keepFiles === {}, 
  Print["❌ No E_only JSON files found under: ", rootEonly];
  Abort[]
];

Print["✅ Found ", Length[keepFiles], " E_only JSON files."];

(* ========= Import all files ========= *)
datasets = Dataset /@ (Import[#, "RawJSON"] & /@ keepFiles);

(* ========= Flatten each dataset ========= *)
flattenOne[ds_] := Flatten[
   Function[row,
     KeyValueMap[
       Function[{col, stats},
         <|
           "File" -> row["File"],
           "TotalRows" -> row["TotalRows"],
           "AnyNaN" -> row["AnyNaN"],
           "AnyInfinity" -> row["AnyInfinity"],
           "AnyMissing" -> row["AnyMissing"],
           "Column" -> col,
           "Mean" -> Lookup[stats, "Mean", Missing[]],
           "StdDev" -> Lookup[stats, "StdDev", Missing[]]
         |>
       ],
       row["Columns"]
     ]
   ] /@ Normal[ds]
];

allFlat = Dataset @ Flatten[flattenOne /@ datasets];

(* ========= Compute averages across all files ========= *)
avgSummary = Dataset @ GroupBy[
   Normal[allFlat],
   #Column &,
   Function[rows,
     <|
       "GlobalMean" -> Mean[DeleteMissing[rows[[All, "Mean"]]]],
       "GlobalStdDev" -> Mean[DeleteMissing[rows[[All, "StdDev"]]]],
       "NumFiles" -> Length[rows]
     |>
   ]
];

(* ========= Show inline ========= *)
Print["\n=== E_only All Files Flattened ==="];
allFlat

Print["\n=== E_only Global Averages (by Column) ==="];
avgSummary

(* ========= Save outputs to Desktop with timestamp ========= *)
timestamp = DateString[{"Year","Month","Day","Hour","Minute","Second"}];
outRoot = FileNameJoin[{$HomeDirectory, "Desktop", "E_only_allfiles_summary_" <> timestamp}];
If[!DirectoryQ[outRoot], CreateDirectory[outRoot]];

cleanAvg = Normal @ avgSummary //. {
   Missing[_] -> Null,
   Indeterminate -> Null,
   _Times -> Null,
   _Complex -> Null,
   Quantity[_, _] -> Null
};

outCSV = FileNameJoin[{outRoot, "E_only_global_avg.csv"}];
outJSON = FileNameJoin[{outRoot, "E_only_global_avg.json"}];

Export[outCSV, cleanAvg];
Export[outJSON, cleanAvg, "JSON"];

Print["\n✅ Saved average CSV:  ", outCSV];
Print["✅ Saved average JSON: ", outJSON];
